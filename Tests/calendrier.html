<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier de M√©lina V4.3 - Export Image</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* --- Styles CSS --- */
        /* ... (Styles CSS identiques √† la version pr√©c√©dente V4.2) ... */
         :root {
            --cell-height: 120px; --day-number-size: 0.9em; --day-note-size: 0.8em;
            --color-melina-me: #fffacd; --color-melina-mother: #ffb6c1; --icon-only-size: 4.5em;
        }
        body { font-family: sans-serif; background-color: #f0f0f0; margin: 0; padding: 10px; }
        .calendar-container {
            background-color: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); text-align: center;
            max-width: 1200px; margin: 10px auto; background-size: cover;
            background-position: center; background-repeat: no-repeat; position: relative;
        }
        .controls-container { /* Conteneur pour les boutons en haut */
            display: flex;
            justify-content: space-between; /* S√©pare les groupes de boutons */
            align-items: center;
            margin-bottom: 15px;
        }
         .background-controls, .export-controls { /* Styles pour les groupes */
             display: flex;
             gap: 5px; /* Espace entre les boutons d'un m√™me groupe */
         }
        .background-controls button, .button-like-label, .export-controls button {
            font-size: 0.8em; padding: 5px 8px; cursor: pointer;
            display: inline-block; border: 1px solid #ccc; border-radius: 4px;
            background-color: #f8f8f8; line-height: normal; /* Assure alignement vertical */
        }
        .button-like-label:hover { background-color: #e8e8e8; }

        .calendar-header { /* ... inchang√© ... */
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; background: rgba(255, 255, 255, 0.8);
            padding: 5px 10px; border-radius: 5px;
        }
        .calendar-header h2 { margin: 0; font-size: 1.8em; }
        .calendar-header button { background: none; border: none; font-size: 1.8em; cursor: pointer; padding: 0 10px; }

        .calendar { /* ... inchang√© ... */ width: 100%; border-collapse: collapse; table-layout: fixed; }
        .calendar th, .calendar td { /* ... inchang√© ... */
            border: 1px solid #ccc; padding: 5px; text-align: center;
            height: var(--cell-height); vertical-align: top; position: relative;
            overflow: hidden; background: rgba(255, 255, 255, 0.85);
        }
        .calendar th { /* ... inchang√© ... */ background-color: #e9e9e9; font-weight: bold; height: auto; padding: 10px 5px; }
        .calendar td { /* ... inchang√© ... */ cursor: pointer; transition: background-color 0.2s; }
        .calendar td:not(.day-outside-month):hover { /* ... inchang√© ... */ background-color: #f5f5f5; }

        .day-content { /* ... inchang√© ... */ display: flex; flex-direction: column; height: 100%; align-items: stretch; }
        .day-number { /* ... inchang√© ... */
            font-weight: bold; font-size: var(--day-number-size); align-self: flex-end;
            padding: 1px 3px; background: rgba(255, 255, 255, 0.7); border-radius: 3px;
            margin-bottom: 3px; z-index: 1;
        }
        .day-details { /* ... inchang√© ... */
            flex-grow: 1; text-align: left; overflow-y: auto; padding-right: 5px;
            display: flex; flex-direction: column;
        }
        .day-note { /* ... inchang√© ... */ font-size: var(--day-note-size); line-height: 1.4; word-wrap: break-word; width: 100%; }
        .event-line { /* ... inchang√© ... */ display: block; margin-bottom: 0.3em; }
        .event-icon { /* ... inchang√© ... */ display: inline-block; width: 1.5em; text-align: center; margin-right: 3px; }

        /* --- Style pour l'ic√¥ne seule --- */
        .day-icon-only .day-details { /* ... inchang√© ... */ justify-content: center; align-items: center; overflow: hidden; }
        .day-icon-only .day-note { /* ... inchang√© ... */ display: none; }
        .day-icon-only .day-number { /* ... inchang√© ... */ display: none; }
        .icon-large { /* ... inchang√© ... */ font-size: var(--icon-only-size); line-height: 1; display: block; text-align: center; }

        /* --- Styles sp√©cifiques Pr√©sence --- */
        .day-melina-me { /* ... inchang√© ... */ background-color: var(--color-melina-me) !important; }
        .day-melina-mother { /* ... inchang√© ... */ background-color: var(--color-melina-mother) !important; }

        /* --- Autres Styles --- */
        .day-outside-month { /* ... inchang√© ... */ color: #bbb; background-color: #fafafa !important; cursor: default; }

        /* --- L√©gende --- */
        .legend { /* ... inchang√© ... */ margin-top: 15px; text-align: left; font-size: 0.9em; background: rgba(255, 255, 255, 0.8); padding: 8px 12px; border-radius: 5px; display: inline-block; }
        .legend-color { /* ... inchang√© ... */ display: inline-block; width: 15px; height: 15px; margin-right: 5px; vertical-align: middle; border: 1px solid #ccc; }
        .legend-item { /* ... inchang√© ... */ margin-bottom: 5px; }
        .legend-item:last-child { margin-bottom: 0; }
        .legend-color-me { background-color: var(--color-melina-me); }
        .legend-color-mother { background-color: var(--color-melina-mother); }

        /* --- Impression --- */
        #printButton { margin-top: 20px; padding: 10px 15px; cursor: pointer; }
        @media print {
             /* Styles d'impression inchang√©s - Ils ne seront PAS utilis√©s par html2canvas */
            @page { size: landscape; margin: 1cm; }
            body { background-color: white !important; padding: 0; margin: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            /* ... reste des styles @media print ... */
            .calendar-container { box-shadow: none; width: 100%; max-width: none; margin: 0; padding: 0; border-radius: 0; background-image: none !important; }
            .controls-container, .calendar-header button, #printButton, .legend { display: none; }
            .calendar-header { justify-content: center; background: none; padding: 0 0 10px 0; }
            .calendar-header h2 { font-size: 1.5em; }
            .calendar { table-layout: fixed; width: 100%; border-collapse: collapse; }
            .calendar th, .calendar td { border: 1px solid #666; height: auto; min-height: 60px; padding: 4px; background: white !important; overflow: visible; }
            .day-melina-me { background-color: var(--color-melina-me) !important; }
            .day-melina-mother { background-color: var(--color-melina-mother) !important; }
            .day-outside-month { color: #ccc !important; background-color: #f8f8f8 !important; }
            .day-details { overflow-y: visible; }
            .day-number { font-size: 0.8em; display: block !important; }
            .day-note { font-size: 0.75em; line-height: 1.3; display: block !important; }
            .event-line { margin-bottom: 0.2em; }
            .event-icon { width: 1.3em; font-size: 0.9em; margin-right: 2px;}
            .day-icon-only .day-details { justify-content: center; align-items: center; }
            .day-icon-only .icon-large { font-size: 2.5em !important; }
            .day-icon-only .day-note { display: none !important; }
            .day-icon-only .day-number { display: block !important; }
        }
    </style>
</head>
<body>

    <div class="calendar-container" id="calendarContainer">
        <div class="controls-container">
            <div class="export-controls">
                 <button id="saveAsImageButton">Enregistrer en Image</button>
            </div>
            <div class="background-controls">
                 <label for="backgroundInput" class="button-like-label">Changer fond</label>
                 <input type="file" id="backgroundInput" accept="image/*" style="display: none;">
                 <button id="removeBackgroundButton">Enlever fond</button>
            </div>
        </div>

        <div class="calendar-header">
            <button id="prevMonth">&lt;</button>
            <h2 id="monthYear"></h2>
            <button id="nextMonth">&gt;</button>
        </div>
        <table class="calendar">
            <thead>
                <tr> <th>Lun</th> <th>Mar</th> <th>Mer</th> <th>Jeu</th> <th>Ven</th> <th>Sam</th> <th>Dim</th> </tr>
            </thead>
            <tbody id="calendarDays">
                </tbody>
        </table>
         <div class="legend">
             <div class="legend-item"><span class="legend-color legend-color-me"></span> : M√©lina avec moi</div>
            <div class="legend-item"><span class="legend-color legend-color-mother"></span> : M√©lina chez sa m√®re</div>
            <div class="legend-item">üñ±Ô∏è Simple clic : Change pr√©sence</div>
            <div class="legend-item">üñ±Ô∏èüñ±Ô∏è Double-clic : G√©rer √©v√©nements (texte+ic√¥ne)</div>
            <div class="legend-item">‚ú® Tapez 'ICON' (double-clic) pour ic√¥ne seule grand format</div>
         </div>
        <br>
        <button id="printButton">Imprimer (Classique)</button>
    </div>

    <script>
        // --- R√©f√©rences aux √©l√©ments (ajout du nouveau bouton) ---
        const monthYearElement = document.getElementById('monthYear');
        const calendarDaysElement = document.getElementById('calendarDays');
        const prevMonthButton = document.getElementById('prevMonth');
        const nextMonthButton = document.getElementById('nextMonth');
        const printButton = document.getElementById('printButton');
        const calendarContainer = document.getElementById('calendarContainer');
        const backgroundInput = document.getElementById('backgroundInput');
        const changeBackgroundLabel = document.querySelector('label[for="backgroundInput"]');
        const removeBackgroundButton = document.getElementById('removeBackgroundButton');
        const saveAsImageButton = document.getElementById('saveAsImageButton'); // Nouveau bouton

        // --- Donn√©es et Configuration (inchang√©) ---
        const STORAGE_KEY = 'melinaCalendarData_v4';
        let currentDate = new Date();
        let storedData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        const availableIcons = [ '', 'üéÇ', '‚≠ê', '‚öΩ', '‚úàÔ∏è', 'üéÅ', '‚õ±Ô∏è', '‚ù§Ô∏è', 'üéâ', 'üìÖ', '‚úèÔ∏è', 'üë©‚Äç‚öïÔ∏è', 'üè´', 'üõí', 'üè†', 'üíº', 'üçΩÔ∏è', 'üò¥', 'üé∂', 'üé®', '‚ùì' ];

        // --- Fonctions : generateCalendar, applyDayData, handleDayClick, handleDayDoubleClick, manageEventsLoop, initDayData, cleanAndSaveData ---
        // ... (Toutes ces fonctions sont identiques √† la version pr√©c√©dente V4.2 avec mot-cl√© ICON) ...
        function generateCalendar(year, month) { /* ... identique ... */
            calendarDaysElement.innerHTML = '';
            const date = new Date(year, month, 1);
            const monthName = date.toLocaleString('fr-FR', { month: 'long' });
            const yearNum = date.getFullYear();
            monthYearElement.textContent = `${monthName} ${yearNum}`;
            const firstDayOfMonth = (date.getDay() + 6) % 7;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            let dayCounter = 1;
            let nextMonthDayCounter = 1;

            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');
                let rowHasDaysOfMonth = false;
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');
                    const dayId = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayCounter).padStart(2, '0')}`;

                    if (i === 0 && j < firstDayOfMonth) { cell.classList.add('day-outside-month'); }
                    else if (dayCounter > daysInMonth) { cell.classList.add('day-outside-month'); nextMonthDayCounter++; }
                    else {
                        rowHasDaysOfMonth = true;
                        cell.dataset.date = dayId;
                        cell.innerHTML = `
                            <div class="day-content">
                                <span class="day-number">${dayCounter}</span>
                                <div class="day-details"></div>
                             </div>
                        `;
                        const dayData = storedData[dayId];
                        applyDayData(cell, dayData || { presence: null, events: [] });

                        cell.addEventListener('click', handleDayClick);
                        cell.addEventListener('dblclick', handleDayDoubleClick);
                        dayCounter++;
                    }
                    row.appendChild(cell);
                }
                if (i === 5 && !rowHasDaysOfMonth) break;
                calendarDaysElement.appendChild(row);
            }
        }

        function applyDayData(cell, dayData) { /* ... identique ... */
             const detailsContainer = cell.querySelector('.day-details');
             if (!detailsContainer.innerHTML.includes('day-note') && !detailsContainer.innerHTML.includes('icon-large')) { detailsContainer.innerHTML = '<div class="day-note"></div>'; }
             const notesContainer = detailsContainer.querySelector('.day-note');

            const isIconOnly = dayData.events && dayData.events.length === 1 && dayData.events[0].text === '' && dayData.events[0].icon !== '';
            cell.classList.toggle('day-icon-only', isIconOnly);

            if (isIconOnly) { detailsContainer.innerHTML = `<span class="icon-large">${dayData.events[0].icon}</span>`; }
            else {
                if (!notesContainer) { detailsContainer.innerHTML = '<div class="day-note"></div>'; }
                const notesDiv = detailsContainer.querySelector('.day-note');
                if (dayData.events && dayData.events.length > 0) {
                    notesDiv.innerHTML = dayData.events.map(event => `<span class="event-line"><span class="event-icon">${event.icon || ''}</span>${event.text || ''}</span>`).join('');
                } else { notesDiv.innerHTML = ''; }
            }

            cell.classList.remove('day-melina-me', 'day-melina-mother');
            if (dayData.presence === 'me') { cell.classList.add('day-melina-me'); }
            else if (dayData.presence === 'mother') { cell.classList.add('day-melina-mother'); }
        }

        function handleDayClick(event) { /* ... identique ... */
            const cell = event.currentTarget; const date = cell.dataset.date; if (!date) return;
            if (!storedData[date]) initDayData(date);
            const currentPresence = storedData[date].presence; let nextPresence = null;
            if (currentPresence === null) nextPresence = 'me';
            else if (currentPresence === 'me') nextPresence = 'mother';
            else if (currentPresence === 'mother') nextPresence = null;
            storedData[date].presence = nextPresence;
            applyDayData(cell, storedData[date]); cleanAndSaveData(date);
        }

        function handleDayDoubleClick(event) { /* ... identique ... */
             const cell = event.currentTarget; const date = cell.dataset.date; if (!date) return;
             if (!storedData[date]) initDayData(date);
             manageEventsLoop(storedData[date], date, cell);
         }

        function manageEventsLoop(currentData, date, cell) { /* ... identique ... */
            const currentEventsText = currentData.events.length > 0 ? currentData.events.map((ev, i) => `${i + 1}: ${ev.icon || '‚ñ´Ô∏è'} ${ev.text}`).join('\n') : '(Aucun √©v√©nement)';
            const actionPrompt = `${currentEventsText}\n\nActions:\n- Entrez le texte d'un √©v√©nement pour l'ajouter (+ choix ic√¥ne).\n- Tapez 'ICON' pour ajouter seulement une ic√¥ne.\n- Entrez le NUM√âRO d'un √©v√©nement pour le supprimer.\n- Tapez 'CLEAR' ou 'EFFACER' pour tout supprimer.\n- Laissez vide ou Annuler pour TERMINER.`;
            const actionInput = prompt(actionPrompt, '');
            if (actionInput === null || actionInput.trim() === '') { cleanAndSaveData(date); applyDayData(cell, currentData); console.log("Fin gestion √©v√©nements."); return; }
            const trimmedInput = actionInput.trim(); const command = trimmedInput.toUpperCase(); const potentialNumber = parseInt(trimmedInput);
            if (command === 'CLEAR' || command === 'EFFACER') { currentData.events = []; console.log("√âv√©nements effac√©s."); manageEventsLoop(currentData, date, cell); return; }
            if (!isNaN(potentialNumber) && potentialNumber > 0 && potentialNumber <= currentData.events.length) { const removedEvent = currentData.events.splice(potentialNumber - 1, 1); console.log("√âv√©nement supprim√©:", removedEvent); manageEventsLoop(currentData, date, cell); return; }
            if (command === 'ICON') { /* ... gestion ICON ... */
                 console.log("Ajout d'une ic√¥ne seule.");
                 const iconPromptText = `Choisissez une ic√¥ne seule (num√©ro ou emoji):\n${availableIcons.map((icon, index) => `${index}: ${icon || 'Aucun'}`).join('\n')}`;
                 const chosenIconInput = prompt(iconPromptText, '0'); let chosenIcon = '';
                 if (chosenIconInput !== null) {
                      const iconIndex = parseInt(chosenIconInput);
                      if (!isNaN(iconIndex) && iconIndex >= 0 && iconIndex < availableIcons.length) { chosenIcon = availableIcons[iconIndex]; }
                      else if (/\p{Emoji}/u.test(chosenIconInput)) { chosenIcon = chosenIconInput; }
                      else { chosenIcon = availableIcons[0]; }
                      if (chosenIcon !== '') { currentData.events.push({ text: "", icon: chosenIcon }); console.log("Ic√¥ne seule ajout√©e:", { text: "", icon: chosenIcon }); }
                      else { console.log("Ajout ic√¥ne seule annul√© (aucune ic√¥ne choisie)."); }
                 } else { console.log("Ajout ic√¥ne seule annul√©."); }
                 manageEventsLoop(currentData, date, cell); return;
             }
            // --- Ajout texte + icone ---
            const newEventText = trimmedInput; console.log("Ajout √©v√©nement avec texte:", newEventText);
            const iconPromptTextForText = `Choisissez une ic√¥ne pour "${newEventText}" (num√©ro ou emoji):\n${availableIcons.map((icon, index) => `${index}: ${icon || 'Aucun'}`).join('\n')}`;
            const chosenIconInputForText = prompt(iconPromptTextForText, '0'); let chosenIconForText = '';
            if (chosenIconInputForText !== null) {
                 const iconIndex = parseInt(chosenIconInputForText);
                 if (!isNaN(iconIndex) && iconIndex >= 0 && iconIndex < availableIcons.length) { chosenIconForText = availableIcons[iconIndex]; }
                 else if (/\p{Emoji}/u.test(chosenIconInputForText)) { chosenIconForText = chosenIconInputForText; }
                 else { chosenIconForText = availableIcons[0]; }
                 currentData.events.push({ text: newEventText, icon: chosenIconForText }); console.log("√âv√©nement texte+ic√¥ne ajout√©:", { text: newEventText, icon: chosenIconForText });
            } else { console.log("Ajout √©v√©nement texte+ic√¥ne annul√© (choix ic√¥ne annul√©)."); }
            manageEventsLoop(currentData, date, cell);
        }

        function initDayData(date) { /* ... identique ... */ if (!storedData[date]) { storedData[date] = { presence: null, events: [] }; } else if (!Array.isArray(storedData[date].events)) { storedData[date].events = []; } }
        function cleanAndSaveData(date) { /* ... identique ... */ const data = storedData[date]; if(data && data.events) { data.events = data.events.filter(event => event.text !== '' || event.icon !== ''); } if (data && data.presence === null && (!data.events || data.events.length === 0)) { delete storedData[date]; } localStorage.setItem(STORAGE_KEY, JSON.stringify(storedData)); }

        // --- Gestion Fond d'√©cran (inchang√©e) ---
        function applyBackground(imageDataUrl) { calendarContainer.style.backgroundImage = imageDataUrl ? `url(${imageDataUrl})` : 'none'; }
        changeBackgroundLabel.addEventListener('click', () => backgroundInput.click());
        backgroundInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (!file || !file.type.startsWith('image/')) return; const reader = new FileReader(); reader.onload = (e) => { const url = e.target.result; if (url.length > 8 * 1024 * 1024) { alert("Image > 8MB..."); localStorage.removeItem('calendarBackground_v4'); applyBackground(url); } else { localStorage.setItem('calendarBackground_v4', url); applyBackground(url); } }; reader.readAsDataURL(file); event.target.value = null; });
        removeBackgroundButton.addEventListener('click', () => { applyBackground(null); localStorage.removeItem('calendarBackground_v4'); });
        const savedBackground = localStorage.getItem('calendarBackground_v4'); if (savedBackground) applyBackground(savedBackground);


        // --- Nouvelle fonction et √©couteur pour l'export image ---
        saveAsImageButton.addEventListener('click', () => {
            const filename = `calendrier-${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}.png`;
            const buttonOriginalText = saveAsImageButton.textContent;
            saveAsImageButton.textContent = 'G√©n√©ration...'; // Feedback visuel
            saveAsImageButton.disabled = true;

            // Options pour html2canvas (augmenter scale pour meilleure r√©solution)
            const options = {
                 scale: 2, // Capture √† 2x la r√©solution native
                 useCORS: true, // Important si l'image de fond venait d'une URL externe
                 logging: false // Mettre √† true pour voir les logs de html2canvas en cas de probl√®me
             };

            console.log('D√©but de la capture html2canvas...');
            html2canvas(calendarContainer, options).then(canvas => {
                console.log('Canvas g√©n√©r√©.');
                // Cr√©er un lien temporaire pour le t√©l√©chargement
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/png'); // Convertit le canvas en image PNG
                console.log('Lien de t√©l√©chargement cr√©√©.');
                link.click(); // Simule un clic pour lancer le t√©l√©chargement
                console.log('T√©l√©chargement lanc√©.');

                // Nettoyage et restauration du bouton
                saveAsImageButton.textContent = buttonOriginalText;
                saveAsImageButton.disabled = false;

            }).catch(error => {
                console.error('Erreur html2canvas:', error);
                alert("Une erreur est survenue lors de la cr√©ation de l'image.\n" + error);
                // Restauration du bouton en cas d'erreur
                saveAsImageButton.textContent = buttonOriginalText;
                saveAsImageButton.disabled = false;
            });
        });

        // --- Navigation et Impression Classique (inchang√©es) ---
        prevMonthButton.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); generateCalendar(currentDate.getFullYear(), currentDate.getMonth()); });
        nextMonthButton.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); generateCalendar(currentDate.getFullYear(), currentDate.getMonth()); });
        printButton.addEventListener('click', () => {
             // On pourrait ajouter un message ici pour rappeler √† l'utilisateur
             // de v√©rifier les options d'impression pour les couleurs/arri√®re-plans
             // s'il utilise cette m√©thode.
             alert("Pour l'impression classique, v√©rifiez les options d'impression (Plus d'options > Graphiques d'arri√®re-plan) pour inclure les couleurs.");
             window.print();
        });

        // --- Initialisation ---
        generateCalendar(currentDate.getFullYear(), currentDate.getMonth());

    </script>

</body>
</html>
