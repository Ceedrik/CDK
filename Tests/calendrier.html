<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier de M√©lina V4.5 - Interaction Am√©lior√©e</title> <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* --- Styles CSS --- */
        :root { /* ... Variables inchang√©es ... */
            --cell-height: 120px; --day-number-size: 0.9em; --day-note-size: 0.8em;
            --color-melina-me: #fffacd; --color-melina-mother: #ffb6c1; --icon-only-size: 4.5em;
        }
        body { font-family: sans-serif; background-color: #f0f0f0; margin: 0; padding: 10px; }
        .calendar-container { /* ... inchang√© ... */
            background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-align: center; max-width: 1200px; margin: 10px auto; background-size: cover;
            background-position: center; background-repeat: no-repeat; position: relative;
        }
        .controls-container { /* ... inchang√© ... */ display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .background-controls, .export-controls { /* ... inchang√© ... */ display: flex; gap: 5px; }
        .background-controls button, .button-like-label, .export-controls button { /* ... inchang√© ... */
            font-size: 0.8em; padding: 5px 8px; cursor: pointer; display: inline-block; border: 1px solid #ccc;
            border-radius: 4px; background-color: #f8f8f8; line-height: normal;
        }
        .button-like-label:hover { background-color: #e8e8e8; }
        .calendar-header { /* ... inchang√© ... */
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.8); padding: 5px 10px; border-radius: 5px;
        }
        .calendar-header h2 { margin: 0; font-size: 1.8em; }
        .calendar-header button { background: none; border: none; font-size: 1.8em; cursor: pointer; padding: 0 10px; }
        .calendar { /* ... inchang√© ... */ width: 100%; border-collapse: collapse; table-layout: fixed; }
        .calendar th, .calendar td { /* ... inchang√© ... */
            border: 1px solid #ccc; padding: 5px; text-align: center; height: var(--cell-height);
            vertical-align: top; position: relative; overflow: hidden; background: rgba(255, 255, 255, 0.85);
        }
        .calendar th { /* ... inchang√© ... */ background-color: #e9e9e9; font-weight: bold; height: auto; padding: 10px 5px; }
        /* Modification : on retire le curseur pointeur pour le simple clic qui ne fait plus rien */
        .calendar td { /* cursor: pointer; */ transition: background-color 0.2s; }
        .calendar td:not(.day-outside-month):hover { background-color: #f5f5f5; }
        .day-content { /* ... inchang√© ... */ display: flex; flex-direction: column; height: 100%; align-items: stretch; }
        .day-number { /* ... inchang√© ... */
            font-weight: bold; font-size: var(--day-number-size); align-self: flex-end; padding: 1px 3px;
            background: rgba(255, 255, 255, 0.7); border-radius: 3px; margin-bottom: 3px; z-index: 1;
        }
        .day-details { /* ... inchang√© ... */ flex-grow: 1; text-align: left; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; }
        .day-note { /* ... inchang√© ... */ font-size: var(--day-note-size); line-height: 1.4; word-wrap: break-word; width: 100%; }
        .event-line { /* ... inchang√© ... */ display: block; margin-bottom: 0.3em; }
        .event-icon { /* ... inchang√© ... */ display: inline-block; width: 1.5em; text-align: center; margin-right: 3px; }

        /* --- Style pour l'ic√¥ne seule --- */
        .day-icon-only .day-details { /* ... inchang√© ... */ justify-content: center; align-items: center; overflow: hidden; }
        .day-icon-only .day-note { /* ... inchang√© ... */ display: none; }
        /* *** MODIFICATION CSS : Supprimer la r√®gle qui cache le num√©ro *** */
        /* .day-icon-only .day-number { display: none; } */ /* R√®gle supprim√©e */
        .icon-large { /* ... inchang√© ... */ font-size: var(--icon-only-size); line-height: 1; display: block; text-align: center; }

        /* --- Styles sp√©cifiques Pr√©sence --- */
        .day-melina-me { /* ... inchang√© ... */ background-color: var(--color-melina-me) !important; }
        .day-melina-mother { /* ... inchang√© ... */ background-color: var(--color-melina-mother) !important; }

        /* --- Autres Styles --- */
        .day-outside-month { /* ... inchang√© ... */ color: #bbb; background-color: #fafafa !important; cursor: default; }

        /* --- L√©gende --- */
        .legend { /* ... inchang√© ... */ margin-top: 15px; text-align: left; font-size: 0.9em; background: rgba(255, 255, 255, 0.8); padding: 8px 12px; border-radius: 5px; display: inline-block; }
        .legend-color { /* ... inchang√© ... */ display: inline-block; width: 15px; height: 15px; margin-right: 5px; vertical-align: middle; border: 1px solid #ccc; }
        .legend-item { /* ... inchang√© ... */ margin-bottom: 5px; } .legend-item:last-child { margin-bottom: 0; }
        .legend-color-me { background-color: var(--color-melina-me); }
        .legend-color-mother { background-color: var(--color-melina-mother); }

        /* --- Impression --- */
        #printButton { /* ... inchang√© ... */ margin-top: 20px; padding: 10px 15px; cursor: pointer; }
        @media print { /* ... Styles @media print inchang√©s (le num√©ro √©tait d√©j√† visible ici) ... */
             @page { size: landscape; margin: 1cm; } body { background-color: white !important; padding: 0; margin: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
             .calendar-container { box-shadow: none; width: 100%; max-width: none; margin: 0; padding: 0; border-radius: 0; background-image: none !important; }
             .controls-container, .calendar-header button, #printButton, .legend { display: none; }
             .calendar-header { justify-content: center; background: none; padding: 0 0 10px 0; } .calendar-header h2 { font-size: 1.5em; }
             .calendar { table-layout: fixed; width: 100%; border-collapse: collapse; }
             .calendar th, .calendar td { border: 1px solid #666; height: auto; min-height: 60px; padding: 4px; background: white !important; overflow: visible; }
             .day-melina-me { background-color: var(--color-melina-me) !important; } .day-melina-mother { background-color: var(--color-melina-mother) !important; }
             .day-outside-month { color: #ccc !important; background-color: #f8f8f8 !important; }
             .day-details { overflow-y: visible; } .day-number { font-size: 0.8em; display: block !important; }
             .day-note { font-size: 0.75em; line-height: 1.3; display: block !important; } .event-line { margin-bottom: 0.2em; }
             .event-icon { width: 1.3em; font-size: 0.9em; margin-right: 2px;}
             .day-icon-only .day-details { justify-content: center; align-items: center; } .day-icon-only .icon-large { font-size: 2.5em !important; }
             .day-icon-only .day-note { display: none !important; } .day-icon-only .day-number { display: block !important; } /* Etait d√©j√† correct ici */
        }
    </style>
</head>
<body>

    <div class="calendar-container" id="calendarContainer">
        <div class="controls-container" id="controlsContainer">
            <div class="export-controls"> <button id="saveAsImageButton">Enregistrer en Image</button> </div>
            <div class="background-controls"> <label for="backgroundInput" class="button-like-label">Changer fond</label> <input type="file" id="backgroundInput" accept="image/*" style="display: none;"> <button id="removeBackgroundButton">Enlever fond</button> </div>
        </div>

        <div class="calendar-header"> <button id="prevMonth">&lt;</button> <h2 id="monthYear"></h2> <button id="nextMonth">&gt;</button> </div>
        <table class="calendar"> <thead> <tr> <th>Lun</th> <th>Mar</th> <th>Mer</th> <th>Jeu</th> <th>Ven</th> <th>Sam</th> <th>Dim</th> </tr> </thead> <tbody id="calendarDays"></tbody> </table>
        <div class="legend" id="legendContainer">
            <div class="legend-item"><span class="legend-color legend-color-me"></span> : M√©lina avec moi</div>
            <div class="legend-item"><span class="legend-color legend-color-mother"></span> : M√©lina chez sa m√®re</div>
            <div class="legend-item">üñ±Ô∏èüñ±Ô∏è Double-clic : G√©rer Pr√©sence / √âv√©nements / Ic√¥nes</div>
            <div class="legend-item">‚ú® Tapez 'ICON' (double-clic) pour ic√¥ne seule grand format</div>
         </div>
        <br>
        <button id="printButton">Imprimer (Classique)</button>
    </div>

    <script>
        // --- R√©f√©rences aux √©l√©ments (inchang√©) ---
        const monthYearElement = document.getElementById('monthYear'); /* ... autres ... */
        const calendarDaysElement = document.getElementById('calendarDays');
        const prevMonthButton = document.getElementById('prevMonth');
        const nextMonthButton = document.getElementById('nextMonth');
        const printButton = document.getElementById('printButton');
        const calendarContainer = document.getElementById('calendarContainer');
        const backgroundInput = document.getElementById('backgroundInput');
        const changeBackgroundLabel = document.querySelector('label[for="backgroundInput"]');
        const removeBackgroundButton = document.getElementById('removeBackgroundButton');
        const saveAsImageButton = document.getElementById('saveAsImageButton');

        // --- Donn√©es et Configuration (inchang√©) ---
        const STORAGE_KEY = 'melinaCalendarData_v4'; // On peut garder V4
        let currentDate = new Date();
        let storedData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        const availableIcons = [ '', 'üéÇ', '‚≠ê', '‚öΩ', '‚úàÔ∏è', 'üéÅ', '‚õ±Ô∏è', '‚ù§Ô∏è', 'üéâ', 'üìÖ', '‚úèÔ∏è', 'üë©‚Äç‚öïÔ∏è', 'üè´', 'üõí', 'üè†', 'üíº', 'üçΩÔ∏è', 'üò¥', 'üé∂', 'üé®', '‚ùì' ];

        // --- Fonctions JS ---

        // generateCalendar (inchang√©e, mais l'event listener pour 'click' sera vid√©)
        function generateCalendar(year, month) { /* ... identique ... */
             calendarDaysElement.innerHTML = ''; const date = new Date(year, month, 1); const monthName = date.toLocaleString('fr-FR', { month: 'long' }); const yearNum = date.getFullYear(); monthYearElement.textContent = `${monthName} ${yearNum}`; const firstDayOfMonth = (date.getDay() + 6) % 7; const daysInMonth = new Date(year, month + 1, 0).getDate(); const daysInPrevMonth = new Date(year, month, 0).getDate(); let dayCounter = 1; let nextMonthDayCounter = 1; for (let i = 0; i < 6; i++) { const row = document.createElement('tr'); let rowHasDaysOfMonth = false; for (let j = 0; j < 7; j++) { const cell = document.createElement('td'); const dayId = `<span class="math-inline">\{year\}\-</span>{String(month + 1).padStart(2, '0')}-${String(dayCounter).padStart(2, '0')}`; if (i === 0 && j < firstDayOfMonth) { cell.classList.add('day-outside-month'); } else if (dayCounter > daysInMonth) { cell.classList.add('day-outside-month'); nextMonthDayCounter++; } else { rowHasDaysOfMonth = true; cell.dataset.date = dayId; cell.innerHTML = ` <div class="day-content"> <span class="day-number">${dayCounter}</span> <div class="day-details"></div> </div> `; const dayData = storedData[dayId]; applyDayData(cell, dayData || { presence: null, events: [] });
             // *** MODIFICATION : L'√©couteur de clic simple est toujours ajout√© mais la fonction handleDayClick sera vid√©e ***
             cell.addEventListener('click', handleDayClick);
             cell.addEventListener('dblclick', handleDayDoubleClick); dayCounter++; } row.appendChild(cell); } if (i === 5 && !rowHasDaysOfMonth) break; calendarDaysElement.appendChild(row); }
        }

        // applyDayData (inchang√©e par rapport √† V4.1/V4.2 car la logique d'affichage est bonne)
        function applyDayData(cell, dayData) { /* ... identique ... */
             const detailsContainer = cell.querySelector('.day-details'); if (!detailsContainer.innerHTML.includes('day-note') && !detailsContainer.innerHTML.includes('icon-large')) { detailsContainer.innerHTML = '<div class="day-note"></div>'; } const notesContainer = detailsContainer.querySelector('.day-note'); const isIconOnly = dayData.events && dayData.events.length === 1 && dayData.events[0].text === '' && dayData.events[0].icon !== ''; cell.classList.toggle('day-icon-only', isIconOnly); if (isIconOnly) { detailsContainer.innerHTML = `<span class="icon-large">${dayData.events[0].icon}</span>`; } else { if (!notesContainer) { detailsContainer.innerHTML = '<div class="day-note"></div>'; } const notesDiv = detailsContainer.querySelector('.day-note'); if (dayData.events && dayData.events.length > 0) { notesDiv.innerHTML = dayData.events.map(event => `<span class="event-line"><span class="event-icon"><span class="math-inline">\{event\.icon \|\| ''\}</span\></span>{event.text || ''}</span>`).join(''); } else { notesDiv.innerHTML = ''; } } cell.classList.remove('day-melina-me', 'day-melina-mother'); if (dayData.presence === 'me') { cell.classList.add('day-melina-me'); } else if (dayData.presence === 'mother') { cell.classList.add('day-melina-mother'); }
        }


        // *** MODIFICATION : Vider la fonction handleDayClick ***
        function handleDayClick(event) {
            // Le clic simple ne fait plus rien pour √©viter les conflits/erreurs.
            // On pourrait l'utiliser plus tard pour "
